# Configuraci?n actualizada de Nginx con HTTPS
# Respaldo creado: nginx.conf.backup

#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # Servidor HTTP (puerto 80) - mantener para compatibilidad
    server {
        listen 80;
        server_name localhost 88.24.21.189;
        index index.php index.html;
        error_log c:/nginx-server/logs/localhost.error.log;
        access_log c:/nginx-server/logs/localhost.access.log;
        root C:\Projects\Canarias-EC;
        autoindex on;

        # Redireccionar a HTTPS
        return 301 https://$server_name:443$request_uri;
    }

    # Servidor HTTPS (puerto 443) - configuraci?n principal
    server {
        listen 443 ssl;
        server_name 88.24.21.189 localhost;
        index index.php index.html;
        error_log c:/nginx-server/logs/ssl.error.log;
        access_log c:/nginx-server/logs/ssl.access.log;
        root C:\Projects\Canarias-EC;
        autoindex on;

        # Configuraci?n SSL
        ssl_certificate C:/Nginx-Server/ssl/nginx.crt;
        ssl_certificate_key C:/Nginx-Server/ssl/nginx.key;
        
        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 5m;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
        ssl_prefer_server_ciphers on;
        ssl_protocols TLSv1.2 TLSv1.3;

        # Headers de seguridad
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        add_header X-XSS-Protection "1; mode=block";

        # Configuraci?n PHP
        location / {
            try_files $uri $uri/ /index.php @forward;
        }

        location ~ \.php {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param SCRIPT_NAME $fastcgi_script_name;
            fastcgi_param HTTPS on;
            fastcgi_index index.php;
            fastcgi_pass 127.0.0.1:9000;
        }

        # Configuraci?n espec?fica para API
        location /api/ {
            try_files $uri $uri/ /index.php?$query_string;
        }
		
		# Configuraci?n para phpMyAdmin
		location /phpmyadmin {
			alias C:/Nginx-Server/phpMyAdmin;
			index index.php index.html;
			
			# Permitir acceso a archivos est?ticos
			location ~ ^/phpmyadmin/(.+\.(jpg|jpeg|gif|css|png|js|ico|html|xml|txt))$ {
				alias C:/Nginx-Server/phpMyAdmin/$1;
			}
			
			# Procesar archivos PHP
			location ~ ^/phpmyadmin/(.+\.php)$ {
				alias C:/Nginx-Server/phpMyAdmin/$1;
				fastcgi_pass 127.0.0.1:9000;
				fastcgi_index index.php;
				include fastcgi_params;
				fastcgi_param SCRIPT_FILENAME C:/Nginx-Server/phpMyAdmin/$1;
				fastcgi_param SCRIPT_NAME /phpmyadmin/$1;
				fastcgi_param PATH_INFO $fastcgi_path_info;
				fastcgi_param HTTPS on;
			}
		}
    }
}